## 1. 累積報酬率 (Cumulative Return)

### 定義

從某一時點（基準日）到另一時點的總報酬百分比。

### 公式

```
累積報酬率 = ((最終價格 / 起始價格) - 1) × 100%
```

### 範例

- 起始價格：$100
- 最終價格：$150
- 累積報酬率 = (150/100 - 1) × 100% = **+50%**

### 時序計算

對於每個交易日，計算相對於起始日的累積報酬：

```python
cumulative_return_t = ((price_t / price_0) - 1) × 100%
```

---

## 2. 基準比較

### 超額報酬 (Alpha)

```
vs_benchmark = 標的報酬率 - 基準報酬率
```

### 預設基準

| 場景     | 預設基準          |
|----------|-------------------|
| 一般股票 | S&P 500 (^GSPC)   |
| 科技股   | Nasdaq 100 (^NDX) |
| 半導體   | 費城半導體 (^SOX) |
| 藍籌股   | Dow Jones (^DJI)  |

### 解讀

| vs_benchmark | 意義                 |
|--------------|----------------------|
| > 0          | 打敗基準，有正 Alpha |
| = 0          | 與基準持平           |
| < 0          | 落後基準，有負 Alpha |

---

## 3. 日期對齊

### 問題

不同標的可能有不同的交易日（例如 ADR vs 美股）。

### 解決方案

1. 抓取所有標的的價格數據
2. 取交集（所有標的都有數據的日期）
3. 對齊後再計算報酬率

```python
combined = combined.dropna()  # 只保留完整數據
```

### 起始日期處理（關鍵方法論）

**核心原則**：累積報酬率的起始點應為「指定年份前一日的收盤價」，即**前一年最後一個交易日**。

例如分析 2024 年的報酬率：
- ❌ 錯誤：從 2024-01-02（第一個交易日）開始計算
- ✅ 正確：從 2023-12-29（2023 年最後一個交易日）開始計算

**處理流程**：

1. 從前一年 12 月開始抓取數據（例如 2023-12-01）
2. 找出**前一年最後一個交易日**（< {year}-01-01 的最後一筆）
3. 以該日期為基準日（base_date），計算累積報酬率

```python
# 取得前一年最後一個交易日
year_start = f"{start_year}-01-01"
prev_year_data = benchmark_data[benchmark_data.index < year_start]
base_date = prev_year_data.index[-1]  # 2023-12-29

# 從 base_date 開始計算報酬率
data = data[data.index >= base_date]
cumulative_return = ((price_end / price_base) - 1) * 100%
```

**為什麼這樣做？**

- 投資者在 2023 年底買入，持有到 2024 年底
- 真實報酬率應從買入日（2023 年最後交易日）計算
- 若從 2024 年第一個交易日計算，會錯過跨年的價格變動

---

## 4. 指數成分股分析

### Top N 排序

1. 抓取所有成分股的價格數據
2. 計算各股的累積報酬率
3. 依報酬率降序排列
4. 取前 N 名

### 統計指標

| 指標           | 計算方式                         |
|----------------|----------------------------------|
| 打敗基準數量   | 報酬率 > 基準報酬率的股票數      |
| 打敗基準比例   | 打敗基準數量 / 總分析數量 × 100% |
| Top N 平均報酬 | Top N 股票報酬率總和 / N         |
| 全體平均報酬   | 所有股票報酬率總和 / 總數        |

---

## 5. 注意事項

### 倖存者偏差

- 成分股列表是**當前**的組成
- 歷史上可能有不同的成分股
- 分析結果會有倖存者偏差

### 股息處理

- 本工具使用**價格報酬**（Price Return）
- **未**計入股息再投資
- 對高股息股票，實際總報酬會更高

### 股票分割

- Yahoo Finance 已調整歷史價格（Adjusted Close）
- 不需額外處理股票分割

---

## 6. 參考資料

- [Investopedia: Cumulative Return](https://www.investopedia.com/terms/c/cumulativereturn.asp)
- [Investopedia: Total Return vs Price Return](https://www.investopedia.com/terms/t/totalreturn.asp)
